language: ruby

rvm:
  - 2.3

services:
  - docker

addons:
  artifacts:
    paths:
      - './log'

env:
  - DOCKER_COMPOSE_VERSION=1.11.1

before_install:
  - docker -v
  - docker-compose -v
  - sudo apt-get update
  - sudo apt-get install docker-engine
  - docker -v
  - docker-compose -v

  # Once travis supports same version, the following can be removed
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose -v

install:
  - docker-compose build

before_script:
  - docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d
  - docker ps
  - docker-compose exec test rails r bin/setup

script:
  - docker-compose exec test rails test

after_script:
  - docker-compose logs > ./log/docker-ci.log
  - docker-compose down

deploy:
  provider: heroku
  app: jfmk-auth-staging
  api_key:
    secure: NPlkg2Q+zOl/uGAj1QoQWo/TOrIB0AqtSAGt6o0NcbdhuzxxVFmgI9ZX4BVy+ubimqp5xH6WDZ50cvuZZ+vDN9957ghSqMIGoIuzBN1r5GNHm4ivhkMatxYTJjKwCYlXeQ7cYT6OQ0wUymQgenYVAvcYrtOx56gA+K62HIDVlIPfDG/gf+pVP909v5EIz/CSaiwIn0tXlfkSO0sJjHlXNZD5i4qoEaRUYAgJ8sVrPg8o538isZj6w6hWrcdGdY8tSa2JIifa3I78vyHM4OF9LCSSOIA/lFGG+4VgWrgDm3K1vJFu+0+v26jVL0rH4YXWSLMGl3rtOes/gwkp/IoG3j+UwT3fQrL4kt03qVX5B+dNvVpQlmWUPkVEhbVmdhoZspvNRhuURM8Zxthz4AFtf2eEBQDrCgZ3WlRTuFYIWqBLcQOlj2lQpex8QpcomStK68sCX8+bibLT1SjCxY4qP9GcE42bn01hLeemfhlP88kSxQXxKq7w97ewrK5Ag3n3AKjIiyvZx1+p0MbRqLL2FSVw0LlTeJVFXIDJEcwqbFPXoyWNhR9lPqBOdtoIxvYnBzmgDTKATTqKeYeldJlr4YawfWkEBDUKrPe5RW9h9Hj4OR+UcvHUF8sBAACbYYMfKZcvxnfq8rZW5aEqmiXXl5VtR02VoOceSzOCTPh+UFc=
  before_deploy:
    - 'rails db:migrate'
    - 'rails db:schema:cache:clear'
    - restart
